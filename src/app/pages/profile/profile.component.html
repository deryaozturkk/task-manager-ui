<!-- src/app/pages/profile/profile.component.html -->

<!-- NAVBAR (AynÄ± kalÄ±yor) -->
<mat-toolbar color="primary" class="main-toolbar">
  <mat-toolbar-row>
    <span>ðŸ’¼ Newcomer Task Manager</span>
    <a mat-button routerLink="/tasks" routerLinkActive="active" 
       matTooltip="GÃ¶rev YÃ¶neticisine Git" class="nav-button">
      <mat-icon>assignment</mat-icon> GÃ¶revler
    </a>
    <a mat-button routerLink="/profile" routerLinkActive="active" 
       matTooltip="Profil ve Åžifre DeÄŸiÅŸtirme" class="nav-button">
      <mat-icon>account_circle</mat-icon> Profilim
    </a>
    <span class="toolbar-spacer"></span>
    <span class="user-info-text">
      {{ authService.getUserRole() === 'admin' ? 'Admin' : 'User' }}: {{ authService.decodeToken()?.username }}
    </span>
    <button mat-icon-button (click)="onLogout()" matTooltip="Ã‡Ä±kÄ±ÅŸ Yap">
      <mat-icon>logout</mat-icon>
    </button>
  </mat-toolbar-row>
</mat-toolbar>

<!-- Ana iÃ§erik -->
<main class="profile-main">
  <!-- Profil Bilgileri KartÄ± (AynÄ± kalÄ±yor) -->
  <mat-card class="profile-card">
    <mat-card-header>
      <mat-card-title>Profil Bilgileri</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p><strong>KullanÄ±cÄ± AdÄ±:</strong> {{ username }}</p>
      <p><strong>Rol:</strong> {{ authService.getUserRole() === 'admin' ? 'YÃ¶netici' : 'KullanÄ±cÄ±' }}</p>
      <mat-divider class="mb-4"></mat-divider>
      <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePassword()" class="password-form">
        <h3>Åžifre DeÄŸiÅŸtirme</h3>
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Mevcut Åžifre</mat-label>
          <input matInput type="password" formControlName="currentPassword" />
          <mat-error *ngIf="changePasswordForm.get('currentPassword')?.hasError('required')">Mevcut ÅŸifre zorunludur.</mat-error>
          <mat-error *ngIf="changePasswordForm.get('currentPassword')?.hasError('minlength')">Mevcut ÅŸifre en az 6 karakter olmalÄ±dÄ±r.</mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Yeni Åžifre</mat-label>
          <input matInput type="password" formControlName="newPassword" />
          <mat-error *ngIf="changePasswordForm.get('newPassword')?.hasError('required')">Yeni ÅŸifre zorunludur.</mat-error>
          <mat-error *ngIf="changePasswordForm.get('newPassword')?.hasError('minlength')">Yeni ÅŸifre en az 6 karakter olmalÄ±dÄ±r.</mat-error>
        </mat-form-field>
        <button mat-raised-button color="primary" type="submit" [disabled]="changePasswordForm.invalid || isChangingPassword">
          <mat-spinner *ngIf="isChangingPassword" [diameter]="24"></mat-spinner>
          <span *ngIf="!isChangingPassword">Åžifreyi GÃ¼ncelle</span>
        </button>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- KullanÄ±cÄ± YÃ¶netimi KartÄ± (Admin Ä°Ã§in) -->
  <mat-card class="user-management-card" *ngIf="userRole === 'admin'">
    <mat-card-header>
      <mat-card-title>KullanÄ±cÄ± YÃ¶netimi</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- YÃ¼kleme Spinner'Ä± -->
      <div *ngIf="isLoadingUsers; else userListContent" class="spinner-container">
        <mat-spinner></mat-spinner>
      </div>

      <ng-template #userListContent>
        <!-- BoÅŸ Liste EkranÄ± -->
        <div *ngIf="users.length === 0" class="empty-state">
          <mat-icon class="empty-icon">people</mat-icon>
          <h3>KullanÄ±cÄ± bulunamadÄ±.</h3>
        </div>

        <!-- KullanÄ±cÄ± Listesi -->
        <mat-list *ngIf="users.length > 0">
          <mat-list-item *ngFor="let user of users" class="user-list-item">
            <!-- Sol Taraf: KullanÄ±cÄ± Bilgisi -->
            <div class="user-info">
              <span class="username">{{ user.username }}</span>
              <span class="current-role">Mevcut Rol: {{ user.role === 'admin' ? 'YÃ¶netici' : 'KullanÄ±cÄ±' }}</span>
            </div>

            <!-- SaÄŸ Taraf: Rol Kontrolleri -->
            <div class="role-controls">
              <!-- EÄŸer admin KENDÄ°SÄ°NE bakÄ±yorsa -->
              <ng-container *ngIf="user.id === loggedInUserId; else roleSelectContainer">
                <span class="self-role-info">(Kendi rolÃ¼nÃ¼zÃ¼ buradan deÄŸiÅŸtiremezsiniz)</span>
              </ng-container>

              <!-- DiÄŸer KullanÄ±cÄ±lar Ä°Ã§in -->
              <ng-template #roleSelectContainer>
                <!-- EÄŸer bu kullanÄ±cÄ± ÅŸu an gÃ¼ncelleniyorsa spinner gÃ¶ster -->
                <mat-spinner *ngIf="updatingRoleId === user.id; else roleSelect" [diameter]="24" class="role-spinner"></mat-spinner>

                <!-- Rol SeÃ§me Dropdown'Ä± -->
                <ng-template #roleSelect>
                  <!-- ðŸ’¡ GÃœNCELLEME: (selectionChange) kaldÄ±rÄ±ldÄ±, (valueChange) eklendi -->
                  <mat-form-field appearance="outline" class="role-select">
                    <mat-label>Yeni Rol</mat-label>
                    <mat-select [value]="user.role" 
                                (valueChange)="onRoleSelectionChange(user.id, $event)">
                      <mat-option value="user">KullanÄ±cÄ±</mat-option>
                      <mat-option value="admin">YÃ¶netici</mat-option>
                    </mat-select>
                  </mat-form-field>
                   <!-- ðŸ’¡ YENÄ°: Kaydet Butonu (Sadece deÄŸiÅŸiklik varsa gÃ¶rÃ¼nÃ¼r) -->
                   <button mat-icon-button color="primary" 
                           *ngIf="pendingRoleChanges[user.id] && pendingRoleChanges[user.id] !== user.role"
                           (click)="onSaveUserRole(user.id, pendingRoleChanges[user.id])"
                           matTooltip="Rol DeÄŸiÅŸikliÄŸini Kaydet">
                     <mat-icon>save</mat-icon>
                   </button>
                </ng-template>
              </ng-template>
            </div>
          </mat-list-item>
        </mat-list>
      </ng-template>
    </mat-card-content>
  </mat-card>
</main>

